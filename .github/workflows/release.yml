name: Release (VS Code Extension)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: Release mode
        type: choice
        required: true
        default: full
        options:
          - full
          - github_from_tag
      bump:
        description: Semver bump (full mode; ignored when version is set)
        type: choice
        required: true
        default: patch
        options:
          - patch
          - minor
          - major
      version:
        description: Explicit version (full mode; overrides bump), e.g. 1.2.3
        type: string
        required: false
      github_tag:
        description: Existing git tag (github_from_tag mode), e.g. v1.2.3
        type: string
        required: false
      publish_to_marketplace:
        description: Publish to VS Code Marketplace (vsce publish)
        type: boolean
        required: true
        default: true
      create_github_release:
        description: Create GitHub Release
        type: boolean
        required: true
        default: true
      upload_vsix_to_github:
        description: Upload VSIX to GitHub Release
        type: boolean
        required: true
        default: true
      draft:
        description: Create GitHub Release as draft
        type: boolean
        required: true
        default: false
      dry_run:
        description: Dry-run (no file changes, no publish)
        type: boolean
        required: true
        default: false

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Select ref
        run: |
          set -euo pipefail

          if [ "${{ inputs.mode }}" = "github_from_tag" ]; then
            if [ -z "${{ inputs.github_tag }}" ]; then
              echo "Input 'github_tag' is required when mode=github_from_tag."
              exit 1
            fi
            raw_tag="${{ inputs.github_tag }}"
            tag="${raw_tag}"

            if ! git show-ref --verify --quiet "refs/tags/${tag}"; then
              if [ "${raw_tag#v}" = "${raw_tag}" ]; then
                candidate="v${raw_tag}"
                if git show-ref --verify --quiet "refs/tags/${candidate}"; then
                  tag="${candidate}"
                fi
              fi
            fi

            if ! git show-ref --verify --quiet "refs/tags/${tag}"; then
              echo "Git tag not found: ${raw_tag}"
              exit 1
            fi

            echo "RELEASE_TAG=${tag}" >> "${GITHUB_ENV}"
            git checkout --detach "${tag}"
            exit 0
          fi

          if [ "${GITHUB_REF_NAME}" != "main" ]; then
            echo "Full releases must be run on the 'main' branch (current: ${GITHUB_REF_NAME})."
            exit 1
          fi

          git checkout -B "${GITHUB_REF_NAME}"

      - name: Install dependencies
        run: npm ci

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Validate secrets
        if: ${{ github.event.inputs.dry_run != 'true' && github.event.inputs.mode == 'full' && github.event.inputs.publish_to_marketplace == 'true' }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          set -euo pipefail
          if [ -z "${VSCE_PAT}" ]; then
            echo "Missing VSCE_PAT secret (required for VS Code Marketplace publishing)."
            exit 1
          fi

      - name: Run release script
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          args=(--yes)

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            args+=(--dry-run)
          fi

          if [ "${{ inputs.draft }}" = "true" ]; then
            args+=(--draft)
          fi

          if [ "${{ inputs.mode }}" = "github_from_tag" ]; then
            if [ -z "${RELEASE_TAG:-}" ]; then
              echo "Missing RELEASE_TAG."
              exit 1
            fi
            tag="${RELEASE_TAG}"

            if [ "${{ inputs.dry_run }}" = "true" ]; then
              args+=(--skip-github-upload)
            fi

            if [ "${{ inputs.create_github_release }}" != "true" ] && [ "${{ inputs.upload_vsix_to_github }}" != "true" ]; then
              args+=(--skip-github)
            else
              if [ "${{ inputs.create_github_release }}" != "true" ]; then
                args+=(--skip-github-create)
              fi
              if [ "${{ inputs.upload_vsix_to_github }}" != "true" ] || [ "${{ inputs.dry_run }}" = "true" ]; then
                args+=(--skip-github-upload)
              fi
            fi

            if [ "${{ inputs.upload_vsix_to_github }}" = "true" ] && [ "${{ inputs.dry_run }}" != "true" ]; then
              ext_name="$(node -p "require('./package.json').name")"
              version="${tag#v}"
              vsix_path="${ext_name}-${version}.vsix"
              vsce package --out "${vsix_path}"
              args+=(--github-tag "${tag}" --github-asset "${vsix_path}")
            else
              args+=(--github-tag "${tag}")
            fi
          else
            if [ -n "${{ inputs.version }}" ]; then
              args+=(--version "${{ inputs.version }}")
            else
              args+=(--bump "${{ inputs.bump }}")
            fi

            if [ "${{ inputs.publish_to_marketplace }}" != "true" ]; then
              args+=(--skip-publish)
            fi

            if [ "${{ inputs.create_github_release }}" != "true" ] && [ "${{ inputs.upload_vsix_to_github }}" != "true" ]; then
              args+=(--skip-github)
            else
              if [ "${{ inputs.create_github_release }}" != "true" ]; then
                args+=(--skip-github-create)
              fi
              if [ "${{ inputs.upload_vsix_to_github }}" != "true" ]; then
                args+=(--skip-github-upload)
              fi
            fi
          fi

          bun run scripts/release.ts "${args[@]}"

      - name: Push release commit
        if: ${{ github.event.inputs.dry_run != 'true' && github.event.inputs.mode == 'full' }}
        run: |
          set -euo pipefail
          if git push origin "HEAD:${GITHUB_REF_NAME}"; then
            echo "Pushed release commit to ${GITHUB_REF_NAME}."
          else
            echo "Unable to push release commit to ${GITHUB_REF_NAME} (branch may be protected)."
            echo "The tag was already pushed by scripts/release.ts; merge/cherry-pick the release commit from the tag if needed."
          fi
